services:
  # 1. Beszel Hub
  hub:
    image: "{{ monitoring_hub_image }}:{{ monitoring_hub_tag }}"
    container_name: "{{ monitoring_hub_container }}"
    restart: "{{ monitoring_restart_policy }}"

    deploy:
      resources:
        limits:
          memory: {{ monitoring_hub_memory }}

    environment:
      TZ: "{{ monitoring_timezone }}"
      APP_URL: "https://{{ monitoring_domain }}"

      # --- [ Auto-Setup Admin ] ---
      # Beszel will create this user on first run if the database is empty
      USER_EMAIL: "{{ monitoring_admin_email }}"
      USER_PASSWORD: "{{ monitoring_admin_password }}"
      # Allow creating users via OIDC
      USER_CREATION: "true"

    volumes:
      - "{{ monitoring_hub_data }}:/beszel_data"

    networks:
      - {{ monitoring_network }}

    # Useful for debugging or if using http://host.docker.internal
    extra_hosts:
      - "host.docker.internal:host-gateway"

    healthcheck:
      test: ["CMD", "/beszel", "health"]
      interval: {{ monitoring_hc_interval }}
      timeout: {{ monitoring_hc_timeout }}
      retries: {{ monitoring_hc_retries }}

    labels:
      caddy: "{{ monitoring_domain }}"
      caddy.import: "secure-headers"
      caddy.reverse_proxy: "{{ monitoring_hub_container }}:8090"


  # 2. Beszel Agent (Active Mode)
  agent:
    image: "{{ monitoring_agent_image }}:{{ monitoring_agent_tag }}"
    container_name: "{{ monitoring_agent_container }}"
    restart: "{{ monitoring_restart_policy }}"
    # Active Mode + Host Network = Best Monitoring capabilities
    network_mode: host

    deploy:
      resources:
        limits:
          memory: {{ monitoring_agent_memory }}

    environment:
      # Agent Key (Dynamic from API or fallback to Vault)
      KEY: "{{ monitoring_dynamic_key | default(monitoring_agent_key) }}"

      # Active Mode: Hub URL + Token
      # Uses external domain (requires NAT Loopback/Hairpinning or open firewall)
      HUB_URL: "https://{{ monitoring_domain }}"

      # Token (User-Scoped, retrieved via API)
      TOKEN: "{{ monitoring_dynamic_token | default('') }}"

      # Mount point for root filesystem monitoring
      FILESYSTEM: "/extra-filesystems/root"

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /:/extra-filesystems/root:ro

networks:
  {{ monitoring_network }}:
    external: true
