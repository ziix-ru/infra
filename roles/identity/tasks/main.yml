---
- name: üîç DEBUG VAULT SOURCE
  debug:
    msg:
      - "Vault loaded: {{ vault_identity is defined }}"
      - "Vault content: {{ vault_identity | default('MISSING') }}"
  tags: [identity, check]

- name: Validate secrets
  ansible.builtin.assert:
    that:
      - identity.lldap.admin.password is defined
      - identity.lldap.keys.seed is defined
    fail_msg: "CRITICAL: Missing Identity secrets!"
  tags: [identity, check]

# 1. Directories
- name: Ensure Identity directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ docker.puid }}"
    group: "{{ docker.pgid }}"
    mode: "0755"
  loop:
    - "{{ identity.path }}"
    - "{{ identity.data_dir }}/lldap"
    - "{{ identity.data_dir }}/pocketid/data"
    - "{{ identity.data_dir }}/tinyauth"
  tags: [identity, filesystem]

# 2. Check Existing Secrets (Idempotency)
- name: Check for existing OIDC secrets
  ansible.builtin.stat:
    path: "{{ identity.path }}/.tinyauth_oidc_secrets"
  register: identity_oidc_file
  tags: [identity, config]

- name: Read existing OIDC secrets
  ansible.builtin.slurp:
    src: "{{ identity.path }}/.tinyauth_oidc_secrets"
  register: identity_oidc_content
  when: identity_oidc_file.stat.exists
  tags: [identity, config]

# 3. Render Compose
- name: Render docker-compose.yml
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ identity.path }}/docker-compose.yml"
    mode: "0640"
    owner: "{{ deploy_user }}"
    group: docker
  vars:
    # Use secrets from file if exist, else empty (wait for auto-setup)
    tinyauth_dynamic_id: >-
      {{ (identity_oidc_content['content'] | b64decode | regex_search('CLIENT_ID=([^\n]+)', '\1') | first) if identity_oidc_file.stat.exists else '' }}
    tinyauth_dynamic_secret: >-
      {{ (identity_oidc_content['content'] | b64decode | regex_search('CLIENT_SECRET=([^\n]+)', '\1') | first) if identity_oidc_file.stat.exists else '' }}
  tags: [identity, config]

# 4. Deploy Stack
- name: Deploy Identity Stack
  community.docker.docker_compose_v2:
    project_src: "{{ identity.path }}"
    state: present
    pull: always
    remove_orphans: true
    recreate: auto
  become: true
  become_user: "{{ deploy_user }}"
  tags: [identity, deploy]

# --- BOOTSTRAP LOGIC ---

# 5. LLDAP Health
- name: Wait for LLDAP healthy
  ansible.builtin.command: "docker inspect --format='{{ '{{' }}.State.Health.Status{{ '}}' }}' lldap"
  register: lldap_health
  retries: 30
  delay: 5
  until: lldap_health.stdout == 'healthy'
  changed_when: false
  tags: [identity, bootstrap]

# 6. LLDAP Init (Admin Attributes)
- name: Bootstrap LLDAP admin
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      # Exec inside container to reach localhost:17170
      docker exec lldap sh -c '
        TOKEN=$(wget -qO- \
          --post-data="{\"username\":\"{{ identity.lldap.admin.dn }}\",\"password\":\"{{ identity.lldap.admin.password }}\"}" \
          --header="Content-Type: application/json" \
          http://127.0.0.1:{{ identity.lldap.port.http }}/auth/simple/login \
          | grep -o "\"token\":\"[^\"]*" | cut -d"\"" -f4)

        if [ -z "$TOKEN" ]; then echo "FAIL"; exit 1; fi

        MUTATION="mutation{updateUser(user:{id:\\\"{{ identity.lldap.admin.dn }}\\\", \
          firstName:\\\"{{ identity.lldap.admin.dn | capitalize }}\\\", \
          email:\\\"{{ identity.lldap.admin.email }}\\\"}){ok}}"

        wget -qO- \
          --post-data="{\"query\":\"$MUTATION\"}" \
          --header="Content-Type: application/json" \
          --header="Authorization: Bearer $TOKEN" \
          http://127.0.0.1:{{ identity.lldap.port.http }}/api/graphql
      ' | grep -q "\"ok\":true"
    executable: /bin/bash
  register: lldap_bootstrap
  changed_when: lldap_bootstrap.rc == 0
  failed_when: lldap_bootstrap.rc != 0
  when: not identity_oidc_file.stat.exists
  notify: Restart PocketID
  tags: [identity, bootstrap]

- name: Flush handlers (Restart PocketID now)
  ansible.builtin.meta: flush_handlers
  tags: [identity, bootstrap]

- name: Wait for PocketID LDAP sync
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      docker logs pocketid --tail 100 | grep -q "Job run successfully.*name=SyncLdap"
    executable: /bin/bash
  register: pocketid_sync
  retries: 30
  delay: 2
  until: pocketid_sync.rc == 0
  changed_when: false
  when: not identity_oidc_file.stat.exists
  tags: [identity, bootstrap]

# 7. Auto-Setup PocketID -> TinyAuth
- name: "‚ö° AUTO-SETUP: OIDC Client"
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      rm -f /tmp/pocket_cookie.txt
      sleep 5

      # 1. Get Token
      LINK=$(docker exec pocketid /app/pocket-id one-time-access-token {{ identity.lldap.admin.dn }})
      TOKEN=$(echo "$LINK" | grep -o 'https://[^ ]*' | awk -F/ '{print $NF}' | tr -d '\r')

      # 2. Login
      curl -s -c /tmp/pocket_cookie.txt -X POST "http://127.0.0.1:{{ identity.pocketid.port }}/api/one-time-access-token/$TOKEN" > /dev/null

      # 3. Create Client
      RESP=$(curl -s -b /tmp/pocket_cookie.txt \
        -X POST "http://127.0.0.1:{{ identity.pocketid.port }}/api/oidc/clients" \
        -H "Content-Type: application/json" \
        -d '{
          "name": "TinyAuth",
          "launchUrl": "https://{{ identity.tinyauth.domain }}",
          "callbackUrls": ["https://{{ identity.tinyauth.domain }}/api/oauth/callback/pocketid"],
          "pkceEnabled": true,
          "isPublic": false
        }')

      ID=$(echo "$RESP" | jq -r '.id // empty')
      SECRET=$(echo "$RESP" | jq -r '.credentials.secret // .clientSecret // empty')

      # 4. Generate Secret if missing
      if [ -n "$ID" ] && [ -z "$SECRET" ]; then
          S_RESP=$(curl -s -b /tmp/pocket_cookie.txt \
            -X POST "http://127.0.0.1:{{ identity.pocketid.port }}/api/oidc/clients/$ID/secret" \
            -H "Content-Type: application/json")
          SECRET=$(echo "$S_RESP" | jq -r '.secret // empty')
      fi

      if [ -n "$ID" ] && [ -n "$SECRET" ]; then
        echo "ID:$ID"
        echo "SECRET:$SECRET"
      fi
    executable: /bin/bash
  register: auto_oidc
  failed_when: false
  changed_when: "'SECRET:' in auto_oidc.stdout"
  when: not identity_oidc_file.stat.exists
  tags: [identity, bootstrap, magic]

# 8. Save Secrets & Redeploy
- name: Save TinyAuth secrets
  ansible.builtin.copy:
    content: |
      CLIENT_ID={{ auto_oidc.stdout | regex_search('ID:([a-zA-Z0-9-]+)', '\1') | first }}
      CLIENT_SECRET={{ auto_oidc.stdout | regex_search('SECRET:([a-zA-Z0-9-]+)', '\1') | first }}
    dest: "{{ identity.path }}/.tinyauth_oidc_secrets"
    mode: "0600"
    owner: "{{ deploy_user }}"
  when:
    - not identity_oidc_file.stat.exists
    - auto_oidc.changed
  tags: [identity, bootstrap]

- name: Set New Secrets Fact
  ansible.builtin.set_fact:
    identity_new_tinyauth_id: "{{ auto_oidc.stdout | regex_search('ID:([a-zA-Z0-9-]+)', '\\1') | first }}"
    identity_new_tinyauth_secret: "{{ auto_oidc.stdout | regex_search('SECRET:([a-zA-Z0-9-]+)', '\\1') | first }}"
  when: auto_oidc.changed
  tags: [identity, bootstrap]

- name: Re-render docker-compose.yml with new secrets
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ identity.path }}/docker-compose.yml"
    mode: "0640"
    owner: "{{ deploy_user }}"
    group: docker
  vars:
    tinyauth_dynamic_id: "{{ identity_new_tinyauth_id }}"
    tinyauth_dynamic_secret: "{{ identity_new_tinyauth_secret }}"
  when: auto_oidc.changed
  tags: [identity, bootstrap]

- name: Re-deploy TinyAuth
  community.docker.docker_compose_v2:
    project_src: "{{ identity.path }}"
    services: [tinyauth]
    state: present
    recreate: always
  become: true
  become_user: "{{ deploy_user }}"
  when: auto_oidc.changed
  tags: [identity, bootstrap]

# 9. Admin Link
- name: Generate One-Time Login Link
  ansible.builtin.command:
    cmd: docker exec pocketid /app/pocket-id one-time-access-token {{ identity.lldap.admin.dn }}
  register: login_link
  changed_when: false
  tags: [identity, token]

- name: Display PocketID Login Link
  ansible.builtin.debug:
    msg:
      - "üîê Login to PocketID Admin Console:"
      - "{{ login_link.stdout }}"
      - "This link is valid for one-time use only."
  tags: [identity, token]
