services:
  {{ amneziawg_service_name }}:
    container_name: {{ amneziawg_service_name }}
    image: {{ amneziawg_image }}
    restart: unless-stopped

    environment:
      NGINX_PORT: "{{ amneziawg_nginx_port }}"
      NGINX_USER: "{{ amneziawg_nginx_user }}"
      NGINX_PASSWORD: "{{ amneziawg_nginx_password }}"
      AUTO_START_SERVERS: "{{ amneziawg_auto_start_servers }}"
      DEFAULT_MTU: "{{ amneziawg_default_mtu }}"
      DEFAULT_SUBNET: "{{ amneziawg_default_subnet }}"
      DEFAULT_PORT: "{{ amneziawg_default_port }}"
      DEFAULT_DNS: "{{ amneziawg_default_dns }}"

    volumes:
      - "{{ amneziawg_data_dir }}:/etc/amnezia"

    ports:
      - "{{ amneziawg_wireguard_port }}:{{ amneziawg_wireguard_port }}/udp"

    cap_add:
      - NET_ADMIN
      - SYS_MODULE

    devices:
      - /dev/net/tun:/dev/net/tun

    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv6.conf.all.disable_ipv6=0
      - net.ipv6.conf.all.forwarding=1
      - net.ipv6.conf.default.forwarding=1

    healthcheck:
      test:
        - "CMD-SHELL"
        - "curl -u {{ amneziawg_nginx_user }}:{{ amneziawg_nginx_password }} -f http://127.0.0.1:{{ amneziawg_nginx_port }}/ || exit 1"
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

    labels:
      traefik.enable: "true"

      # Имя сети, в которой Traefik нас увидит
      traefik.docker.network: "{{ docker_network_name }}"

      # Динамические имена роутеров
      traefik.http.routers.{{ amneziawg_service_name }}-http.rule: "Host(`{{ amneziawg_domain }}`)"
      traefik.http.routers.{{ amneziawg_service_name }}-http.entrypoints: "web"
      traefik.http.routers.{{ amneziawg_service_name }}-http.service: "{{ amneziawg_service_name }}"

      traefik.http.routers.{{ amneziawg_service_name }}.rule: "Host(`{{ amneziawg_domain }}`)"
      traefik.http.routers.{{ amneziawg_service_name }}.entrypoints: "websecure"
      traefik.http.routers.{{ amneziawg_service_name }}.tls: "true"
      traefik.http.routers.{{ amneziawg_service_name }}.tls.certresolver: "letsencrypt"
      traefik.http.routers.{{ amneziawg_service_name }}.service: "{{ amneziawg_service_name }}"

      traefik.http.services.{{ amneziawg_service_name }}.loadbalancer.server.port: "{{ amneziawg_nginx_port }}"

    networks:
      - {{ docker_network_name }}

networks:
  {{ docker_network_name }}:
    external: true
