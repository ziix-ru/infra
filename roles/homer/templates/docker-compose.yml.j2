services:
  {{ homer.service }}:
    image: "{{ homer.image }}"
    container_name: "{{ homer.service }}"
    restart: "unless-stopped"

    deploy:
      resources:
        limits:
          memory: {{ homer.memory }}

    environment:
      - TZ={{ system.timezone | default('UTC') }}
      - PUID={{ docker.puid }}
      - PGID={{ docker.pgid }}

    volumes:
      - "{{ homer.assets_dir }}:/www/assets"

    networks:
      - {{ docker.network }}

    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:8080/ || exit 1"]
      interval: {{ homer.healthcheck.interval }}
      timeout: {{ homer.healthcheck.timeout }}
      retries: {{ homer.healthcheck.retries }}
      start_period: {{ homer.healthcheck.start_period }}

    labels:
      # === INGRESS: CADDY ===
      caddy: "{{ homer.domain }}"
      caddy.import: "secure-headers"

{% if homer.auth.enabled | bool %}
      # Auth (TinyAuth)
      caddy.route.0_forward_auth: "tinyauth:3000"
      caddy.route.0_forward_auth.uri: "/api/auth/caddy"
      caddy.route.0_forward_auth.copy_headers: "{{ homer.auth.header_user }} Remote-Name Remote-Email Remote-Groups"
{% endif %}

      caddy.route.9_reverse_proxy: "{{ homer.service }}:{{ homer.port }}"

{% if homer.autoheal | bool %}
      autoheal: "true"
{% endif %}

networks:
  {{ docker.network }}:
    external: true
