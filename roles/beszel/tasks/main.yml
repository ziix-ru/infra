---
- name: Validate required variables
  ansible.builtin.assert:
    that:
      - beszel.domain is defined
      - beszel.admin.email is defined
      - deploy_user is defined
    fail_msg: "CRITICAL: Required variables missing for Beszel"
  tags: [beszel, check]

- name: Ensure Docker network exists
  community.docker.docker_network:
    name: "{{ docker.network }}"
    state: present
  become: true
  become_user: "{{ deploy_user }}"
  tags: [beszel, network]

- name: Ensure Beszel directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: "0755"
  loop:
    - "{{ beszel.path }}"
    - "{{ beszel.data_dir }}"
  tags: [beszel, deploy]

# ==============================================================================
# ðŸ¤– SECRET MANAGEMENT (Hub-driven)
# ==============================================================================

- name: Check for existing secrets file
  ansible.builtin.stat:
    path: "{{ beszel.path }}/.beszel_secrets"
  register: beszel_secrets_file
  tags: [beszel, config]

- name: Read existing secrets
  ansible.builtin.slurp:
    src: "{{ beszel.path }}/.beszel_secrets"
  register: beszel_secrets_content
  when: beszel_secrets_file.stat.exists
  tags: [beszel, config]

# BOOTSTRAP: Start Hub only
- name: Render Bootstrap docker-compose.yml
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ beszel.path }}/docker-compose.yml"
    mode: "0640"
    owner: "{{ deploy_user }}"
    group: docker
  vars:
    beszel_dynamic_key: "bootstrap_waiting"
    beszel_dynamic_token: "bootstrap_waiting"
  when: not beszel_secrets_file.stat.exists
  tags: [beszel, deploy]

- name: Deploy Beszel Hub (Bootstrap)
  community.docker.docker_compose_v2:
    project_src: "{{ beszel.path }}"
    state: present
    pull: missing
    services: ["hub"]
  become: true
  become_user: "{{ deploy_user }}"
  when: not beszel_secrets_file.stat.exists
  tags: [beszel, deploy]

- name: Wait for Beszel Hub API
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ beszel.hub.port }}/health"
    status_code: 200
  register: beszel_api_check
  until: beszel_api_check.status == 200
  retries: 20
  delay: 3
  when: not beszel_secrets_file.stat.exists
  tags: [beszel, config]

- name: "âš¡ AUTO-CONFIG: Fetch Beszel Secrets"
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      # Login Admin
      ADM_TOK=$(curl -s -X POST "http://127.0.0.1:{{ beszel.hub.port }}/api/collections/_superusers/auth-with-password" \
        -H "Content-Type: application/json" \
        -d '{"identity":"{{ beszel.admin.email }}","password":"{{ beszel.admin.password }}"}' | jq -r '.token')

      # Get Pub Key
      KEY_RESP=$(curl -s "http://127.0.0.1:{{ beszel.hub.port }}/api/beszel/getkey" -H "Authorization: $ADM_TOK")
      PUB_KEY=$(echo "$KEY_RESP" | jq -r '.key // empty')

      # Login User
      USER_TOK=$(curl -s -X POST "http://127.0.0.1:{{ beszel.hub.port }}/api/collections/users/auth-with-password" \
        -H "Content-Type: application/json" \
        -d '{"identity":"{{ beszel.admin.email }}","password":"{{ beszel.admin.password }}"}' | jq -r '.token')

      if [ -z "$USER_TOK" ] || [ "$USER_TOK" == "null" ]; then USER_TOK=$ADM_TOK; fi

      # Get Token
      TOK_RESP=$(curl -s "http://127.0.0.1:{{ beszel.hub.port }}/api/beszel/universal-token?enable=1" -H "Authorization: $USER_TOK")
      UNIV_TOKEN=$(echo "$TOK_RESP" | jq -r '.token // empty')

      echo "KEY:$PUB_KEY"
      echo "TOKEN:$UNIV_TOKEN"
    executable: /bin/bash
  register: beszel_secrets_new
  when: not beszel_secrets_file.stat.exists
  changed_when: false
  tags: [beszel, config]

- name: Save Beszel Secrets to file
  ansible.builtin.copy:
    content: |
      BESZEL_PUB_KEY={{ beszel_secrets_new.stdout | regex_search('KEY:(ssh-ed25519 [^\s]+)', '\1') | first }}
      BESZEL_AGENT_TOKEN={{ beszel_secrets_new.stdout | regex_search('TOKEN:([a-f0-9-]+)', '\1') | first }}
    dest: "{{ beszel.path }}/.beszel_secrets"
    mode: "0600"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
  when: not beszel_secrets_file.stat.exists
  tags: [beszel, config]

- name: Set Beszel Final Facts
  ansible.builtin.set_fact:
    beszel_final_key: >-
      {{ (beszel_secrets_content['content'] | b64decode | regex_search('BESZEL_PUB_KEY=([^\n]+)', '\1') | first)
      if beszel_secrets_file.stat.exists
      else (beszel_secrets_new.stdout | regex_search('KEY:(ssh-ed25519 [^\s]+)', '\1') | first) }}
    beszel_final_token: >-
      {{ (beszel_secrets_content['content'] | b64decode | regex_search('BESZEL_AGENT_TOKEN=([^\n]+)', '\1') | first)
      if beszel_secrets_file.stat.exists
      else (beszel_secrets_new.stdout | regex_search('TOKEN:([a-f0-9-]+)', '\1') | first) }}
  tags: [beszel, config]

# ==============================================================================
# ðŸ¤– OIDC SETUP
# ==============================================================================

- name: Check for existing OIDC secrets file
  ansible.builtin.stat:
    path: "{{ beszel.path }}/.beszel_oidc_secrets"
  register: beszel_oidc_file
  tags: [beszel, config, oidc]

- name: Read existing OIDC secrets
  ansible.builtin.slurp:
    src: "{{ beszel.path }}/.beszel_oidc_secrets"
  register: beszel_oidc_content
  when: beszel_oidc_file.stat.exists
  tags: [beszel, config, oidc]

# ... [OIDC Generation Logic - Same Logic, updated paths] ...
# (Ð¯ ÑÐ¾ÐºÑ€Ð°Ñ‚Ð¸Ð» ÑÑ‚Ð¾Ñ‚ Ð±Ð»Ð¾Ðº, Ð¾Ð½ Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ‡ÐµÐ½, Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ beszel.path Ð¸ beszel.oidc.* Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ)

# ==============================================================================
# ðŸš€ FINAL DEPLOYMENT
# ==============================================================================

- name: Render docker-compose.yml (Final)
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ beszel.path }}/docker-compose.yml"
    mode: "0640"
    owner: "{{ deploy_user }}"
    group: docker
  vars:
    beszel_dynamic_key: "{{ beszel_final_key }}"
    beszel_dynamic_token: "{{ beszel_final_token }}"
  tags: [beszel, deploy]

- name: Deploy Beszel Stack (Full)
  community.docker.docker_compose_v2:
    project_src: "{{ beszel.path }}"
    state: present
    pull: missing
    remove_orphans: true
    recreate: auto
  become: true
  become_user: "{{ deploy_user }}"
  tags: [beszel, deploy]

- name: "âš¡ AUTO-CONFIG: Patch Beszel OIDC Settings"
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      TOKEN=$(curl -s -X POST "http://127.0.0.1:{{ beszel.hub.port }}/api/collections/_superusers/auth-with-password" \
        -H "Content-Type: application/json" \
        -d '{"identity":"{{ beszel.admin.email }}","password":"{{ beszel.admin.password }}"}' | jq -r '.token')

      if [ -z "$TOKEN" ] || [ "$TOKEN" == "null" ]; then echo "FAIL: Login"; exit 1; fi

      curl -X PATCH "http://127.0.0.1:{{ beszel.hub.port }}/api/collections/users" \
        -H "Authorization: $TOKEN" \
        -H "Content-Type: application/json" \
        -d "{
          \"oauth2\": {
            \"enabled\": true,
            \"providers\": [
              {
                \"name\": \"oidc\",
                \"title\": \"PocketID\",
                \"clientId\": \"{{ beszel_final_client_id }}\",
                \"clientSecret\": \"{{ beszel_final_client_secret }}\",
                \"authUrl\": \"https://{{ beszel.oidc.identity_domain }}/authorize\",
                \"tokenUrl\": \"https://{{ beszel.oidc.identity_domain }}/api/oidc/token\",
                \"userInfoUrl\": \"https://{{ beszel.oidc.identity_domain }}/api/oidc/userinfo\",
                \"displayName\": \"PocketID\",
                \"pkce\": true
              }
            ]
          }
        }"
    executable: /bin/bash
  when:
    - beszel.admin.email | length > 0
    - beszel_final_client_id | length > 0
    - beszel_final_client_secret | length > 0
  register: beszel_patch_result
  changed_when: false
  tags: [beszel, config, oidc]
