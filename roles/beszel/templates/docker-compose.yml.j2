services:
  # 1. Beszel Hub
  hub:
    image: "{{ beszel.hub.image }}"
    container_name: "{{ beszel.service }}-hub"
    restart: "unless-stopped"

    deploy:
      resources:
        limits:
          memory: {{ beszel.hub.memory }}

    ports:
      - "127.0.0.1:{{ beszel.hub.port }}:8090"

    environment:
      TZ: "{{ system.timezone | default('UTC') }}"
      APP_URL: "https://{{ beszel.domain }}"
      USER_EMAIL: "{{ beszel.admin.email }}"
      USER_PASSWORD: "{{ beszel.admin.password }}"
      USER_CREATION: "true"

    volumes:
      - "{{ beszel.data_dir }}:/beszel_data"

    networks:
      - {{ docker.network }}

    extra_hosts:
      - "host.docker.internal:host-gateway"

    healthcheck:
      test: ["CMD", "/beszel", "health"]
      interval: {{ beszel.healthcheck.interval }}
      timeout: {{ beszel.healthcheck.timeout }}
      retries: {{ beszel.healthcheck.retries }}

    labels:
      caddy: "{{ beszel.domain }}"
      caddy.import: "secure-headers"
      caddy.reverse_proxy: "{{ beszel.service }}-hub:8090"

{% if beszel.autoheal | bool %}
      autoheal: "true"
{% endif %}


  # 2. Beszel Agent
  agent:
    image: "{{ beszel.agent.image }}"
    container_name: "{{ beszel.service }}-agent"
    restart: "unless-stopped"
    network_mode: host

    healthcheck:
      test: ["CMD", "/agent", "-v"]
      interval: {{ beszel.healthcheck.interval }}
      timeout: {{ beszel.healthcheck.timeout }}
      retries: {{ beszel.healthcheck.retries }}

    deploy:
      resources:
        limits:
          memory: {{ beszel.agent.memory }}

    environment:
      KEY: "{{ beszel_dynamic_key | default(beszel.agent.key) }}"
      # Hub URL for Agent (Localhost via host networking)
      HUB_URL: "http://127.0.0.1:{{ beszel.hub.port }}"
      TOKEN: "{{ beszel_dynamic_token | default('') }}"
      FILESYSTEM: "/extra-filesystems/root"

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /:/extra-filesystems/root:ro

    labels:
{% if beszel.autoheal | bool %}
      autoheal: "true"
{% endif %}

networks:
  {{ docker.network }}:
    external: true
