services:
  {{ dozzle.service }}:
    image: "{{ dozzle.image }}"
    container_name: "{{ dozzle.service }}"
    restart: "unless-stopped"
    security_opt:
      - no-new-privileges:true

    deploy:
      resources:
        limits:
          memory: {{ dozzle.memory }}

    environment:
      TZ: "{{ system.timezone | default('UTC') }}"
{% if dozzle.config.no_analytics %}
      DOZZLE_NO_ANALYTICS: "true"
{% endif %}
{% if dozzle.config.enable_actions %}
      DOZZLE_ENABLE_ACTIONS: "true"
{% endif %}
{% if dozzle.config.enable_shell %}
      DOZZLE_ENABLE_SHELL: "true"
{% endif %}

{% if dozzle.auth.enabled %}
      DOZZLE_AUTH_PROVIDER: "forward-proxy"
      DOZZLE_AUTH_HEADER_USER: "{{ dozzle.auth.header_user }}"
      DOZZLE_AUTH_HEADER_EMAIL: "{{ dozzle.auth.header_email }}"
      DOZZLE_AUTH_HEADER_NAME: "{{ dozzle.auth.header_name }}"
{% endif %}

{% if dozzle.socket_proxy | bool %}
      DOZZLE_REMOTE_HOST: "tcp://socket-proxy:2375"
{% endif %}

{% if not dozzle.socket_proxy | bool %}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
{% endif %}

    networks:
      - {{ docker.network }}
{% if dozzle.socket_proxy | bool %}
      - socket_proxy
{% endif %}

    healthcheck:
      test: ["CMD", "/dozzle", "healthcheck"]
      interval: {{ dozzle.healthcheck.interval }}
      timeout: {{ dozzle.healthcheck.timeout }}
      retries: {{ dozzle.healthcheck.retries }}
      start_period: {{ dozzle.healthcheck.start_period }}

    labels:
      # === INGRESS: CADDY ===
      caddy: "{{ dozzle.domain }}"
      caddy.import: "secure-headers"

{% if dozzle.auth.enabled %}
      caddy.route.0_forward_auth: "tinyauth:3000"
      caddy.route.0_forward_auth.uri: "/api/auth/caddy"
      caddy.route.0_forward_auth.copy_headers: "{{ dozzle.auth.header_user }} {{ dozzle.auth.header_name }} {{ dozzle.auth.header_email }} Remote-Groups"
{% endif %}

{% if dozzle.sablier.enabled | bool %}
      # Sablier Middleware
      caddy.route.1_sablier: ""
      caddy.route.1_sablier.group: "{{ dozzle.sablier.group }}"
      caddy.route.1_sablier.dynamic: ""
      caddy.route.1_sablier.dynamic.display_name: "{{ dozzle.sablier.display_name }}"
      caddy.route.1_sablier.dynamic.theme: "{{ dozzle.sablier.theme }}"
      caddy.route.1_sablier.dynamic.refresh_frequency: "5s"
{% endif %}

      caddy.route.9_reverse_proxy: "{{ dozzle.service }}:{{ dozzle.port }}"

{% if dozzle.autoheal | bool %}
      autoheal: "true"
{% endif %}

{% if dozzle.sablier.enabled | bool %}
      # Sablier Agent Labels
      sablier.enable: "true"
      sablier.group: "{{ dozzle.sablier.group }}"
      sablier.window: "{{ dozzle.sablier.window }}"
{% endif %}

networks:
  {{ docker.network }}:
    external: true
{% if dozzle.socket_proxy | bool %}
  socket_proxy:
    external: true
{% endif %}
