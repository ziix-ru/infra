---
- name: Validate required variables
  ansible.builtin.assert:
    that:
      - crowdsec.bouncer_key is defined
      - deploy_user is defined
    fail_msg: "Required variables missing for CrowdSec"
  tags: [crowdsec, check]

# --- PART 1: DOCKER AGENT ---

- name: Ensure CrowdSec directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
  loop:
    - "{{ crowdsec.path }}"
    - "{{ crowdsec.path }}/config"
    - "{{ crowdsec.path }}/data"
  tags: [crowdsec, filesystem]

- name: Render acquis.yaml
  ansible.builtin.template:
    src: acquis.yaml.j2
    dest: "{{ crowdsec.path }}/acquis.yaml"
    mode: '0644'
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
  notify: Restart CrowdSec
  tags: [crowdsec, config]

- name: Render docker-compose.yml
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ crowdsec.path }}/docker-compose.yml"
    mode: '0644'
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
  notify: Restart CrowdSec
  tags: [crowdsec, config]

- name: Deploy CrowdSec Agent
  community.docker.docker_compose_v2:
    project_src: "{{ crowdsec.path }}"
    state: present
    pull: missing
    remove_orphans: true
  become: true
  become_user: "{{ deploy_user }}"
  tags: [crowdsec, deploy]

# --- PART 2: HOST BOUNCER ---

- name: Download CrowdSec GPG key
  ansible.builtin.get_url:
    url: "https://packagecloud.io/crowdsec/crowdsec/gpgkey"
    dest: "/usr/share/keyrings/crowdsec_crowdsec-archive-keyring.asc"
    mode: '0644'
  tags: [crowdsec, system]

- name: Add CrowdSec Repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/crowdsec_crowdsec-archive-keyring.asc] https://packagecloud.io/crowdsec/crowdsec/debian/ bookworm main"
    state: present
    filename: crowdsec_crowdsec
  tags: [crowdsec, system]

- name: Install Firewall Bouncer (IPTables)
  ansible.builtin.apt:
    name: crowdsec-firewall-bouncer-iptables
    state: present
    update_cache: true
  tags: [crowdsec, system]

- name: Configure Firewall Bouncer
  ansible.builtin.template:
    src: crowdsec-firewall-bouncer.yaml.j2
    dest: "/etc/crowdsec/bouncers/crowdsec-firewall-bouncer.yaml"
    mode: '0600'
  notify: Restart Bouncer
  tags: [crowdsec, config]

- name: Enable and Start Bouncer
  ansible.builtin.systemd:
    name: crowdsec-firewall-bouncer
    enabled: true
    state: started
  tags: [crowdsec, deploy]

# --- PART 3: REGISTRATION ---

# We use 'shell' instead of 'docker_container_exec' for specific exit code handling
- name: Register Bouncer with Agent
  ansible.builtin.shell:
    cmd: >
      docker exec crowdsec cscli bouncers add firewall-bouncer --key {{ crowdsec.bouncer_key }}
  register: bouncer_reg
  # Ignore error if already registered ("already exists" or similar error)
  # Ideally check if registered first, but this is idempotent enough for now
  failed_when:
    - bouncer_reg.rc != 0
    - "'already exists' not in bouncer_reg.stderr"
  changed_when: "'registered' in bouncer_reg.stdout"
  become: true
  tags: [crowdsec, deploy]
