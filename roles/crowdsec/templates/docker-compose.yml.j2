services:
  # --- AGENT (LAPI + Parser) ---
  agent:
    image: crowdsecurity/crowdsec:latest
    container_name: crowdsec
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: {{ crowdsec_memory_limit }}
    environment:
      GID: "1000"
      COLLECTIONS: "{{ crowdsec_collections | join(' ') }}"

    volumes:
      - ./acquis.yaml:/etc/crowdsec/acquis.yaml
      - ./config:/etc/crowdsec
      - ./data:/var/lib/crowdsec/data
      # Системные логи (SSH)
      - /var/log/auth.log:/var/log/auth.log:ro
      - /var/log/syslog:/var/log/syslog:ro
      # Логи Caddy (читаем из папки Caddy)
      - {{ docker_base_dir }}/caddy/logs:/var/log/caddy:ro

    ports:
      # Открываем LAPI на localhost:8080 для хостового баунсера
      - "127.0.0.1:8080:8080"
    networks:
      - {{ docker_network_name }}

    security_opt:
      - no-new-privileges=true

    healthcheck:
      test: ["CMD", "cscli", "metrics"]
      interval: {{ crowdsec_hc_interval }}
      timeout: {{ crowdsec_hc_timeout }}
      retries: {{ crowdsec_hc_retries }}
      start_period: {{ crowdsec_hc_start_period }}

    labels:
      autoheal: "true"

networks:
  {{ docker_network_name }}:
    external: true
