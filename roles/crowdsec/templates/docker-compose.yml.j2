services:
  {{ crowdsec.service }}:
    image: "{{ crowdsec.image }}"
    container_name: "{{ crowdsec.service }}"
    restart: "unless-stopped"

    deploy:
      resources:
        limits:
          memory: {{ crowdsec.memory }}

    environment:
      # Run as user 1000 to match host files if needed, or default
      GID: "1000"
      COLLECTIONS: "{{ crowdsec.collections | join(' ') }}"

    volumes:
      - ./acquis.yaml:/etc/crowdsec/acquis.yaml
      - ./config:/etc/crowdsec
      - ./data:/var/lib/crowdsec/data
      # System Logs
      - {{ crowdsec.logs.system_auth }}:/var/log/auth.log:ro
      - {{ crowdsec.logs.system_syslog }}:/var/log/syslog:ro
      # Caddy Logs
      - {{ crowdsec.logs.caddy }}:/var/log/caddy:ro

    ports:
      # Expose LAPI to localhost ONLY (for host bouncer)
      - "127.0.0.1:{{ crowdsec.api.port }}:8080"

    networks:
      - {{ docker.network }}

    security_opt:
      - no-new-privileges=true

    healthcheck:
      test: ["CMD", "cscli", "metrics"]
      interval: {{ crowdsec.healthcheck.interval }}
      timeout: {{ crowdsec.healthcheck.timeout }}
      retries: {{ crowdsec.healthcheck.retries }}
      start_period: {{ crowdsec.healthcheck.start_period }}

{% if crowdsec.autoheal | bool %}
    labels:
      autoheal: "true"
{% endif %}

networks:
  {{ docker.network }}:
    external: true
