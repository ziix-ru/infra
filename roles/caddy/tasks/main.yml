---
- name: Validate required variables
  ansible.builtin.assert:
    that:
      - caddy_acme_email is defined
      - docker_network_name is defined
      - deploy_user is defined
    fail_msg: "Required variables missing for Caddy role"
  tags: [caddy, check]

- name: Ensure Caddy directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: "0755"
  loop:
    - "{{ caddy_compose_dir }}"
    - "{{ caddy_config_dir }}"
    - "{{ caddy_data_dir }}"
    - "{{ caddy_logs_dir }}"
  tags: [caddy, filesystem]

# --- НОВАЯ ЗАДАЧА: Создаем файл лога с правами на чтение ---
- name: Ensure Caddy access log file exists with readable permissions
  ansible.builtin.file:
    path: "{{ caddy_logs_dir }}/access.log"
    state: touch
    owner: "root"     # Caddy в контейнере обычно пишет от root
    group: "root"
    mode: "0644"      # rw-r--r-- (Чтение доступно всем)
  tags: [caddy, filesystem]
# -----------------------------------------------------------

- name: Render Caddyfile & Dockerfile
  ansible.builtin.template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: "0644"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
  loop:
    - { src: "Caddyfile.j2", dest: "{{ caddy_config_dir }}/Caddyfile" }
    - { src: "Dockerfile.j2", dest: "{{ caddy_compose_dir }}/Dockerfile" }
  register: caddy_configs
  tags: [caddy, config]

- name: Render docker-compose.yml
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ caddy_compose_dir }}/docker-compose.yml"
    mode: "0640"
    owner: "{{ deploy_user }}"
    group: docker
  register: caddy_compose
  tags: [caddy, config]

- name: Allow HTTP/HTTPS ports (UFW)
  community.general.ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
    comment: "Caddy Web Server"
  loop:
    - "80"
    - "443"
  tags: [caddy, firewall]

- name: Create .dockerignore for Caddy
  ansible.builtin.copy:
    dest: "{{ caddy_compose_dir }}/.dockerignore"
    mode: "0644"
    content: |
      .git
      node_modules
      data
      config
      logs
      tmp
  tags: [caddy, config]

- name: Build Caddy Image
  community.docker.docker_image:
    name: "{{ caddy_service_name }}:local"
    source: build
    build:
      path: "{{ caddy_compose_dir }}"
      pull: true
    force_source: "{{ caddy_configs.changed }}"
  tags: [caddy, build]

- name: Deploy Caddy Stack
  community.docker.docker_compose_v2:
    project_src: "{{ caddy_compose_dir }}"
    state: present
    pull: never
    remove_orphans: true
  become: true
  become_user: "{{ deploy_user }}"
  tags: [caddy, deploy]
