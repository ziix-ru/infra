---
- name: Ensure Caddy directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: "0755"
  loop:
    - "{{ caddy_compose_dir }}"
    - "{{ caddy_config_dir }}"
    - "{{ caddy_data_dir }}"

- name: Render Caddyfile & Dockerfile
  ansible.builtin.template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: "0644"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
  loop:
    - { src: "Caddyfile.j2", dest: "{{ caddy_config_dir }}/Caddyfile" }
    - { src: "Dockerfile.j2", dest: "{{ caddy_compose_dir }}/Dockerfile" }
  register: caddy_configs

- name: Render docker-compose.yml
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ caddy_compose_dir }}/docker-compose.yml"
    mode: "0640"
    owner: "{{ deploy_user }}"
    group: docker
  register: caddy_compose

- name: Allow HTTP/HTTPS ports (UFW)
  community.general.ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
    comment: "Caddy Web Server"
  loop:
    - "80"
    - "443"

- name: Build Caddy Image
  community.docker.docker_image:
    name: "{{ caddy_service_name }}:local"
    source: build
    build:
      path: "{{ caddy_compose_dir }}"
      pull: true
    force_source: "{{ caddy_configs.changed }}"

- name: Deploy Caddy Stack
  community.docker.docker_compose_v2:
    project_src: "{{ caddy_compose_dir }}"
    state: present
    pull: never
    remove_orphans: true
  become: true
  become_user: "{{ deploy_user }}"
