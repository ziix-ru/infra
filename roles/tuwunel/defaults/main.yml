---
# ansible-lint: disable:var-naming[no-role-prefix]
tuwunel:
  service: "tuwunel"

  # Images (Compact)
  image: "docker.io/jevolk/tuwunel:latest"

  # Domains
  domain: "matrix.{{ domain.base }}"
  server_name: "{{ domain.base }}" # Базовый домен для имен пользователей (@user:ziix.ru)

  # Paths
  path: "{{ docker.base_dir }}/tuwunel"

  # --- CONFIGURATION ---
  config:
    allow_registration: true
    allow_federation: true
    allow_encryption: true
    max_request_size: 20971520 # 20MB
    # Ulimits (critical for high load)
    ulimit: 1048567
    log_level: "info"

  # --- SECRETS (From Vault) ---
  registration_token: "{{ vault_matrix.registration_token | default('') }}"

  # --- LDAP ---
  ldap:
    enabled: true
    uri: "ldap://lldap:3890"
    base_dn: "ou=people,dc=ziix,dc=ru"
    bind_dn: "uid={{ vault_identity.lldap.admin_login }},ou=people,dc=ziix,dc=ru"
    bind_password: "{{ vault_identity.lldap.admin_password | default('') }}"
    # Password file inside container
    bind_password_file: "/var/lib/tuwunel/.ldap_bind_password"

  # --- RESOURCES ---
  memory: "{{ docker.defaults.memory | default('384M') }}"

  # --- INTEGRATIONS ---
  autoheal: true

  # --- HEALTHCHECK ---
  healthcheck:
    interval: "30s"
    timeout: "5s"
    retries: 3


# === LIVEKIT SUB-COMPONENT ===
livekit:
  service: "livekit"
  image: "livekit/livekit-server:latest"
  domain: "livekit.{{ domain.base }}"

  # Secrets
  key: "{{ vault_matrix.livekit.key }}"
  secret: "{{ vault_matrix.livekit.secret }}"

  # Ports (Inherit from Global Vars)
  ports:
    http: 7880
    tcp: "{{ ports.livekit.tcp }}"
    udp_start: "{{ ports.livekit.udp.start }}"
    udp_end: "{{ ports.livekit.udp.end }}"

  memory: "384M"
  log_level: "info"


# === JWT SERVICE SUB-COMPONENT ===
jwt_service:
  service: "lk-jwt-service"
  image: "ghcr.io/element-hq/lk-jwt-service:latest"
  port: 8081
  memory: "64M"
  log_level: "info"
