services:
  # === 1. TUWUNEL (MATRIX) ===
  {{ tuwunel.service }}:
    image: "{{ tuwunel.image }}"
    container_name: "{{ tuwunel.service }}"
    restart: "unless-stopped"

    deploy:
      resources:
        limits:
          memory: {{ tuwunel.memory }}

    volumes:
      - ./config/tuwunel.toml:/etc/tuwunel/tuwunel.toml:ro
      - ./data:/var/lib/tuwunel
{% if tuwunel.ldap.enabled %}
      - ./.ldap_bind_password:{{ tuwunel.ldap.bind_password_file }}:ro
{% endif %}

    networks:
      - {{ docker.network }}

    environment:
      - TUWUNEL_CONFIG=/etc/tuwunel/tuwunel.toml
      - TUWUNEL_LOG={{ tuwunel.config.log_level }}
      - TZ={{ system.timezone | default('UTC') }}

    ulimits:
      nofile:
        soft: {{ tuwunel.config.ulimit }}
        hard: {{ tuwunel.config.ulimit }}

    healthcheck:
      test: ["CMD", "tuwunel", "--version"]
      interval: {{ tuwunel.healthcheck.interval }}
      timeout: {{ tuwunel.healthcheck.timeout }}
      retries: {{ tuwunel.healthcheck.retries }}
      start_period: 40s

    labels:
      # === INGRESS: MATRIX ===
      caddy: "{{ tuwunel.domain }}"
      caddy.import: "secure-headers"
      caddy.route: ""

      # .well-known Client
      caddy.route.0_handle_path: "/.well-known/matrix/client"
      caddy.route.0_handle_path.header_0: "Access-Control-Allow-Origin *"
      caddy.route.0_handle_path.header_1: "+Content-Type application/json"
      caddy.route.0_handle_path.respond: '`{ "m.homeserver":{"base_url":"https://{{ tuwunel.domain }}"}, "org.matrix.msc4143.rtc_foci":[{"type":"livekit","livekit_service_url":"https://{{ livekit.domain }}","jwt_service_url":"https://{{ livekit.domain }}/sfu/get"}] }`'

      # .well-known Server
      caddy.route.1_handle_path: "/.well-known/matrix/server"
      caddy.route.1_handle_path.header_0: "Access-Control-Allow-Origin *"
      caddy.route.1_handle_path.header_1: "+Content-Type application/json"
      caddy.route.1_handle_path.respond: '`{"m.server":"{{ tuwunel.domain }}:443"}`'

      # Proxy
      caddy.route.2_reverse_proxy: "{{ tuwunel.service }}:8008"

      # === INGRESS: ROOT DOMAIN (Delegation) ===
      caddy_1: "{{ tuwunel.server_name }}"
      caddy_1.import: "secure-headers"
      caddy_1.route: ""

      # Повторяем well-known для базового домена
      caddy_1.route.0_handle_path: "/.well-known/matrix/client"
      caddy_1.route.0_handle_path.header_0: "Access-Control-Allow-Origin *"
      caddy_1.route.0_handle_path.header_1: "+Content-Type application/json"
      caddy_1.route.0_handle_path.respond: '`{ "m.homeserver":{"base_url":"https://{{ tuwunel.domain }}"}, "org.matrix.msc4143.rtc_foci":[{"type":"livekit","livekit_service_url":"https://{{ livekit.domain }}","jwt_service_url":"https://{{ livekit.domain }}/sfu/get"}] }`'

      caddy_1.route.1_handle_path: "/.well-known/matrix/server"
      caddy_1.route.1_handle_path.header_0: "Access-Control-Allow-Origin *"
      caddy_1.route.1_handle_path.header_1: "+Content-Type application/json"
      caddy_1.route.1_handle_path.respond: '`{"m.server":"{{ tuwunel.domain }}:443"}`'

{% if tuwunel.autoheal | bool %}
      autoheal: "true"
{% endif %}

  # === 2. LIVEKIT ===
  {{ livekit.service }}:
    image: "{{ livekit.image }}"
    container_name: "{{ livekit.service }}"
    restart: "unless-stopped"

    deploy:
      resources:
        limits:
          memory: {{ livekit.memory }}

    command: --config /etc/livekit.yaml

    environment:
      - TZ={{ system.timezone | default('UTC') }}

    networks:
      - {{ docker.network }}

    ports:
      - "{{ livekit.ports.http }}:{{ livekit.ports.http }}"
      - "{{ livekit.ports.tcp }}:{{ livekit.ports.tcp }}"
      - "{{ livekit.ports.udp_start }}-{{ livekit.ports.udp_end }}:{{ livekit.ports.udp_start }}-{{ livekit.ports.udp_end }}/udp"

    volumes:
      - ./config/livekit.yaml:/etc/livekit.yaml:ro

    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:{{ livekit.ports.http }}"]
      interval: {{ tuwunel.healthcheck.interval }}
      timeout: {{ tuwunel.healthcheck.timeout }}
      retries: {{ tuwunel.healthcheck.retries }}
      start_period: 20s

    labels:
      # === INGRESS: LIVEKIT ===
      caddy: "{{ livekit.domain }}"
      caddy.import: "secure-headers"
      caddy.route: ""

      # JWT Auth Service
      caddy.route.0_handle: "/sfu/get*"
      caddy.route.0_handle.reverse_proxy: "{{ jwt_service.service }}:{{ jwt_service.port }}"

      # LiveKit API
      caddy.route.1_reverse_proxy: "{{ livekit.service }}:{{ livekit.ports.http }}"

{% if tuwunel.autoheal | bool %}
      autoheal: "true"
{% endif %}

  # === 3. JWT SERVICE ===
  {{ jwt_service.service }}:
    image: "{{ jwt_service.image }}"
    container_name: "{{ jwt_service.service }}"
    restart: "unless-stopped"

    deploy:
      resources:
        limits:
          memory: {{ jwt_service.memory }}

    environment:
      - LIVEKIT_JWT_BIND=:{{ jwt_service.port }}
      - LIVEKIT_URL=https://{{ livekit.domain }}
      - LIVEKIT_KEY={{ livekit.key }}
      - LIVEKIT_SECRET={{ livekit.secret }}
      - LIVEKIT_FULL_ACCESS_HOMESERVERS={{ tuwunel.server_name }}
      - LIVEKIT_LOG_LEVEL={{ jwt_service.log_level }}
      - TZ={{ system.timezone | default('UTC') }}

    networks:
      - {{ docker.network }}

networks:
  {{ docker.network }}:
    external: true
